#!/usr/bin/env coffee
fs            = require 'fs'
path          = require 'path'
{spawn, exec} = require 'child_process'

# npm
CoffeeScript = require '../node_modules/coffee-script'
optimist = require '../node_modules/optimist'

argv = optimist
  .usage("npm packages in CoffeeScript (package.coffee -> package.json)")
  .alias('v', 'version')
  .describe('v', 'Print version')
  .argv

if argv.v or argv.version
  console.log fs.readFileSync './VERSION', 'utf8'
  process.exit 0

fs.readFile 'package.coffee', 'utf8', (error, coffee) ->
  if error
    console.log "error: #{error}"
    process.exit -1

  console.log coffee

  js = CoffeeScript.compile "return {
    #{coffee}
  }"

  console.log js

  json = JSON.stringify eval(js), null, 2

  fs.writeFile 'package.json', json, ->
    console.log json if argv.p || argv.print